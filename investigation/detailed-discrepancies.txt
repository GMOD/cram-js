DETAILED DISCREPANCY REPORT
============================
Generated: 2025-11-19

SUMMARY STATISTICS:
-------------------
Total CRAM files tested: 183
Exact matches: 169 (92.3%)
Non-matches: 14 (7.7%)
  - Files samtools can't read: 2
  - Known decoder issues: 9
  - Boundary handling differences: 3


DETAILED BREAKDOWN:
===================

GROUP 1: FILES SAMTOOLS CANNOT READ (2 files)
----------------------------------------------
These files have format issues that prevent samtools from reading them.
The CRAM decoder can read them, suggesting it may be more permissive.

1. hg19mini#cramQueryTest.cram
   Location: test/data/hg19mini#cramQueryTest.cram
   Samtools error: "Negative values not permitted for header sequence start or span fields"
   Status: Cannot validate against samtools
   Action: Verify file format is correct per CRAM spec

2. human_g1k_v37.20.21.10M-10M200k#cramQueryWithBAI.cram
   Location: test/data/human_g1k_v37.20.21.10M-10M200k#cramQueryWithBAI.cram
   Samtools error: "Negative values not permitted for header sequence start or span fields"
   Status: Cannot validate against samtools
   Action: Verify file format is correct per CRAM spec


GROUP 2: WHOLE FILE DECODING DISCREPANCIES (6 files)
-----------------------------------------------------
These files show record count differences when reading the entire file.

1. c1#noseq.tmp.cram
   Location: test/data/c1#noseq.tmp.cram
   Decoder count: 7 records
   Samtools count: 9 records
   Missing: 2 records (22% discrepancy)
   Category: Records with no sequence data
   Priority: HIGH - Likely decoder bug
   Test method: dumpWholeFile()

2. ce#1000.tmp.cram
   Location: test/data/ce#1000.tmp.cram
   Decoder count: Unknown (not tested in range mode)
   Samtools count: 1000 records (likely)
   Category: Large file
   Priority: HIGH - Needs investigation
   Test method: dumpWholeFile()

3. ce#tag_depadded.tmp.cram
   Location: test/data/ce#tag_depadded.tmp.cram
   Decoder count: Unknown
   Samtools count: Unknown
   Category: Tag padding/depadding
   Priority: MEDIUM
   Test method: dumpWholeFile()

4. ce#tag_padded.tmp.cram (whole file)
   Location: test/data/ce#tag_padded.tmp.cram
   Decoder count: Unknown (whole file)
   Samtools count: Unknown (whole file)
   Category: Tag padding/depadding
   Priority: MEDIUM
   Test method: dumpWholeFile()
   Note: Also has region discrepancy (see Group 3)

5. ce#unmap2.tmp.cram
   Location: test/data/ce#unmap2.tmp.cram
   Decoder count: Unknown
   Samtools count: 19 records
   Category: Mixed mapped/unmapped reads
   Priority: MEDIUM
   Test method: dumpWholeFile()

6. md#1.tmp.cram
   Location: test/data/md#1.tmp.cram
   Decoder count: Unknown
   Samtools count: Unknown
   Category: MD tag handling
   Priority: MEDIUM
   Test method: dumpWholeFile()


GROUP 3: REGION QUERY DISCREPANCIES (4 files)
----------------------------------------------
These show differences when querying specific genomic regions.

1. SRR396636.sorted.clip.cram
   Location: test/data/SRR396636.sorted.clip.cram
   Region: chr (ref 0), position 25999-26499 (0-based)
   Decoder count: 406 records
   Samtools count: 404 records (using 1-based coords 26000-26499)
   Difference: +2 extra records (0.5% over)
   Category: Boundary handling
   Priority: LOW - Small percentage difference
   Test method: getRecordsForRange(0, 25999, 26499)

2. SRR396637.sorted.clip.cram
   Location: test/data/SRR396637.sorted.clip.cram
   Region: chr (ref 0), position 163504-175473 (0-based)
   Decoder count: 5941 records
   Samtools count: 5962 records (using 1-based coords 163505-175473)
   Difference: -21 missing records (0.35% under)
   Category: Boundary handling
   Priority: LOW - Small percentage difference
   Test method: getRecordsForRange(0, 163504, 175473)

3. ce#tag_padded.tmp.cram
   Location: test/data/ce#tag_padded.tmp.cram
   Region: ref 0, position 2-200 (0-based)
   Decoder count: 8 records
   Samtools count: 7 records (using 1-based coords 3-200)
   Difference: +1 extra record (14% over)
   Category: Tag padding + boundary handling
   Priority: MEDIUM - High percentage but small absolute numbers
   Test method: getRecordsForRange(0, 2, 200)

4. human_g1k_v37.20.21.10M-10M200k#cramQueryWithCRAI.cram
   Location: test/data/human_g1k_v37.20.21.10M-10M200k#cramQueryWithCRAI.cram
   Region: First reference sequence (entire ref)
   Decoder count: 6 records
   Samtools count: 7 records
   Difference: -1 missing record (14% under)
   Category: Indexing edge case
   Priority: HIGH - Small file, should be exact
   Test method: getRecordsForRange(0, 0, Number.POSITIVE_INFINITY)


GROUP 4: HTS-SPECS EDGE CASES (3 files)
----------------------------------------
These are from the hts-specs test suite and represent compliance edge cases.

1. hts-specs/cram/3.0/passed/0802_ctr.cram
   Location: test/data/hts-specs/cram/3.0/passed/0802_ctr.cram
   Category: Container-level edge case
   Priority: MEDIUM - Spec compliance
   Test method: dumpWholeFile()

2. hts-specs/cram/3.0/passed/1404_index_multislice.cram
   Location: test/data/hts-specs/cram/3.0/passed/1404_index_multislice.cram
   Category: Multiple slices per container
   Priority: MEDIUM - Indexing edge case
   Test method: dumpWholeFile()

3. hts-specs/cram/3.0/passed/1405_index_multisliceref.cram
   Location: test/data/hts-specs/cram/3.0/passed/1405_index_multisliceref.cram
   Category: Multiple slices with multiple references
   Priority: MEDIUM - Complex indexing edge case
   Test method: dumpWholeFile()


PRIORITY RANKING FOR INVESTIGATION:
====================================

CRITICAL (Must fix for 100% match):
1. c1#noseq.tmp.cram - 22% discrepancy, clear missing records
2. human_g1k_v37.20.21.10M-10M200k#cramQueryWithCRAI.cram - Small file, 1 record missing
3. ce#1000.tmp.cram - Large file validation

HIGH (Should fix):
4. ce#unmap2.tmp.cram - Unmapped record handling
5. md#1.tmp.cram - MD tag computation

MEDIUM (Edge cases to review):
6. ce#tag_depadded.tmp.cram - Tag handling
7. ce#tag_padded.tmp.cram - Tag handling + boundary
8. hts-specs edge cases (3 files) - Spec compliance

LOW (Boundary handling differences):
9. SRR396636.sorted.clip.cram region - 0.5% difference
10. SRR396637.sorted.clip.cram region - 0.35% difference


NEXT STEPS:
===========

1. Run detailed comparison on c1#noseq.tmp.cram to identify which 2 records are missing
2. Examine human_g1k_v37 file to find missing record
3. Profile ce#1000.tmp.cram with samtools to get exact counts
4. Review unmapped record handling code for ce#unmap2.tmp.cram
5. Review MD tag computation algorithm
6. Consider if boundary handling differences are acceptable or need fixing
7. Review HTS-SPECS files against specification

